!function(o){class e{constructor(){window.downloadHandlerInitialized||(window.downloadHandlerInitialized=!0,this.downloadSection=o("#resource-download-section"),this.downloadButton=o("#download-resources-btn"),this.downloadStatus=o("#download-status"),this.isDownloading=!1,this.initializeEventListeners())}initializeEventListeners(){o(document).off("forminator:form:submit:success"),this.downloadButton.off("click"),o(document).on("forminator:form:submit:success",(o=>{o.stopPropagation(),this.showDownloadSection()})),this.downloadButton.on("click",(o=>{o.preventDefault(),o.stopPropagation(),this.isDownloading||this.handleDownloadClick(o)}))}showDownloadSection(){this.downloadSection.show().css("opacity","0").animate({opacity:1},800)}async handleDownloadClick(e){if(this.isDownloading)return;this.isDownloading=!0;const n=o(e.currentTarget);try{n.prop("disabled",!0).html('\n                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>\n                        Preparing Download...\n                    '),await this.startDownload(n)}catch(o){console.error("Download error:",o),this.showError(o.message||"Download failed")}finally{setTimeout((()=>{this.resetButton(n),this.isDownloading=!1}),1500)}}async startDownload(o){const e=new FormData;e.append("action","download_all_documents"),e.append("nonce",documentAjax.nonce),e.append("post_id",o.data("post-id"));try{const o=await this.makeDownloadRequest(e);await this.handleDownloadResponse(o)}catch(o){throw new Error(o.message||"Download failed. Please try again.")}}async makeDownloadRequest(e){return new Promise(((n,a)=>{o.ajax({url:documentAjax.ajaxurl,type:"POST",data:e,processData:!1,contentType:!1,xhrFields:{responseType:"blob"},success:(o,e,a)=>{n({response:o,xhr:a})},error:o=>{"blob"===o.responseType?this.handleBlobError(o).then(a).catch(a):a(new Error("Download failed. Please try again."))}})}))}async handleDownloadResponse({response:o,xhr:e}){const n=e.getResponseHeader("content-type");if(n.includes("application/json")){const e=await this.readBlobAsText(o),n=JSON.parse(e);throw new Error(n.data?.message||"Download failed")}if(!n.includes("application/zip"))throw new Error("Unexpected response type");await this.processZipDownload(o)}async readBlobAsText(o){return new Promise(((e,n)=>{const a=new FileReader;a.onload=()=>e(a.result),a.onerror=()=>n(new Error("Failed to read response")),a.readAsText(o)}))}async processZipDownload(o){const e=window.URL.createObjectURL(o),n=document.createElement("a");n.href=e,n.download="resources.zip",n.click(),setTimeout((()=>{window.URL.revokeObjectURL(e)}),100)}resetButton(o){o.prop("disabled",!1).html('\n                    <i class="fas fa-file-archive me-2"></i>\n                    Download All Resources\n                ')}showError(e){const n=o(`\n                <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">\n                    ${e}\n                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                </div>\n            `);this.downloadStatus.html("").append(n),setTimeout((()=>n.alert("close")),5e3)}}window.handlerInstance||o(document).ready((function(){try{window.handlerInstance=new e}catch(o){console.error("Failed to initialize DocumentDownloadHandler:",o)}}))}(jQuery);